python_library(
    name = "coroutine_utils",
    srcs = ["coroutine_utils.py"],
    base_module = "btrfs_diff",
)

python_unittest(
    name = "test-coroutine-utils",
    srcs = ["tests/test_coroutine_utils.py"],
    base_module = "btrfs_diff",
    needed_coverage = [(
        1.0,
        ":coroutine_utils",
    )],
    deps = [":coroutine_utils"],
)

python_library(
    name = "extent",
    srcs = ["extent.py"],
    base_module = "btrfs_diff",
)

python_unittest(
    name = "test-extent",
    srcs = ["tests/test_extent.py"],
    base_module = "btrfs_diff",
    needed_coverage = [(
        1.0,
        ":extent",
    )],
    deps = [":extent"],
)

python_library(
    name = "deepcopy_test",
    srcs = ["tests/deepcopy_test.py"],
    base_module = "btrfs_diff",
)

python_library(
    name = "inode_id",
    srcs = ["inode_id.py"],
    base_module = "btrfs_diff",
)

python_unittest(
    name = "test-inode-id",
    srcs = ["tests/test_inode_id.py"],
    base_module = "btrfs_diff",
    needed_coverage = [(
        1.0,
        ":inode_id",
    )],
    deps = [
        ":coroutine_utils",
        ":deepcopy_test",
        ":inode_id",
    ],
)

python_library(
    name = "inode",
    srcs = ["inode.py"],
    base_module = "btrfs_diff",
    deps = [
        ":extent",
        ":inode_id",
    ],
)

python_unittest(
    name = "test-inode",
    srcs = ["tests/test_inode.py"],
    base_module = "btrfs_diff",
    needed_coverage = [(
        1.0,
        ":inode",
    )],
    deps = [
        ":extents_to_chunks",
        ":inode",
    ],
)

python_library(
    name = "incomplete_inode",
    srcs = ["incomplete_inode.py"],
    base_module = "btrfs_diff",
    deps = [
        ":extent",
        ":inode",
        ":inode_id",
        ":parse_send_stream",
    ],
)

python_unittest(
    name = "test-incomplete-inode",
    srcs = ["tests/test_incomplete_inode.py"],
    base_module = "btrfs_diff",
    needed_coverage = [(
        1.0,
        ":incomplete_inode",
    )],
    deps = [":incomplete_inode"],
)

python_library(
    name = "extents_to_chunks",
    srcs = ["extents_to_chunks.py"],
    base_module = "btrfs_diff",
    deps = [
        ":extent",
        ":inode",
        ":inode_id",
    ],
)

python_unittest(
    name = "test-extents-to-chunks",
    srcs = ["tests/test_extents_to_chunks.py"],
    base_module = "btrfs_diff",
    needed_coverage = [(
        1.0,
        ":extents_to_chunks",
    )],
    deps = [":extents_to_chunks"],
)

python_library(
    name = "parse_send_stream",
    srcs = [
        "parse_dump.py",
        "parse_send_stream.py",
        "send_stream.py",
    ],
    base_module = "btrfs_diff",
    deps = [
        "//tools/build/buck/infra_macros/macro_lib/convert/container_image/" +
        "compiler:enriched_namedtuple",
    ],
)

# The reason we need the gold data is explained in `demo_sendtreams.py`.
export_file(
    name = "gold_demo_sendstreams.pickle",
    src = "tests/gold_demo_sendstreams.pickle",
)

python_unittest(
    name = "test-send-stream",
    srcs = [
        "tests/btrfs_utils.py",
        "tests/demo_sendstreams.py",
        "tests/demo_sendstreams_expected.py",
        "tests/test_parse_dump.py",
        "tests/test_parse_send_stream.py",
    ],
    base_module = "btrfs_diff",
    gen_srcs = {
        ":gold_demo_sendstreams.pickle": "tests/gold_demo_sendstreams.pickle",
    },
    needed_coverage = [(
        1.0,
        ":parse_send_stream",
    )],
    # "fastzip" won't work for two reasons: (i) we re-execute
    # "demo_sendstreams.py", (ii) we have an 'export_file' dep.
    par_style = "zip",
    deps = [
        ":gold_demo_sendstreams.pickle",
        ":parse_send_stream",
        "//tools/build/buck/infra_macros/macro_lib/convert/container_image" +
        ":artifacts_dir",
        "//tools/build/buck/infra_macros/macro_lib/convert/container_image" +
        ":volume_for_repo",
    ],
)

python_library(
    name = "subvolume",
    srcs = ["subvolume.py"],
    base_module = "btrfs_diff",
    deps = [
        ":coroutine_utils",
        ":incomplete_inode",
        ":inode_id",
        ":parse_send_stream",
    ],
)

python_unittest(
    name = "test-subvolume",
    srcs = [
        "tests/subvolume_utils.py",
        "tests/test_subvolume.py",
    ],
    base_module = "btrfs_diff",
    needed_coverage = [(
        1.0,
        ":subvolume",
    )],
    deps = [
        ":deepcopy_test",
        ":subvolume",
    ],
)

python_library(
    name = "subvolume_set",
    srcs = ["subvolume_set.py"],
    base_module = "btrfs_diff",
    deps = [
        ":inode_id",
        ":parse_send_stream",
        ":subvolume",
    ],
)

python_unittest(
    name = "test-subvolume-set",
    srcs = ["tests/test_subvolume_set.py"],
    base_module = "btrfs_diff",
    needed_coverage = [(
        1.0,
        ":subvolume_set",
    )],
    deps = [":subvolume_set"],
)
